@if (open) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity"
    data-backdrop="true" (click)="onBackdropClick($event)">

    <div class="bg-white dark:bg-[#1a140f] rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col border border-[#e6e0db] dark:border-white/10"
        role="dialog" aria-modal="true">

        <!-- Header -->
        <div
            class="px-6 py-4 border-b hover:cursor-pointer border-[#e6e0db] dark:border-white/10 flex items-center justify-between sticky top-0 bg-white dark:bg-[#1a140f] z-10">
            <h2 class="text-xl font-bold text-[#181411] dark:text-white">
                {{ isEdit ? 'Editar Producto' : 'Nuevo Producto' }}
            </h2>
            <button type="button" (click)="onClose()"
                class="text-gray-400 hover:cursor-pointer hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Body -->
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 flex flex-col gap-6">

            <!-- Name Field -->
            <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-[#181411] dark:text-white">Nombre</label>
                <input formControlName="name" type="text"
                    class="form-input w-full px-3 py-2 rounded-lg border border-[#e6e0db] dark:border-white/10 bg-white dark:bg-black/20 text-[#181411] dark:text-white focus:border-[#f27f0d] focus:ring-1 focus:ring-[#f27f0d] outline-none transition-all placeholder:text-gray-400"
                    placeholder="Nombre del producto" />
                @if(hasError('name', 'required')) { <span class="text-xs text-red-500">Requerido</span> }
                @if(hasError('name', 'minlength')) { <span class="text-xs text-red-500">Mínimo 2 letras</span> }
            </div>

            <!-- Category & Price -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col gap-1">
                    <label class="text-sm font-semibold text-[#181411] dark:text-white">Categoría</label>
                    <div class="relative">
                        <select formControlName="categoryId"
                            class="form-select w-full px-3 py-2 rounded-lg border border-[#e6e0db] dark:border-white/10 bg-white dark:bg-black/20 text-[#181411] dark:text-white focus:border-[#f27f0d] focus:ring-1 focus:ring-[#f27f0d] outline-none transition-all appearance-none cursor-pointer">
                            <option value="" disabled>Seleccionar...</option>
                            @for(c of categories; track c.id) {
                            <option [value]="c.id">{{ c.name }}</option>
                            }
                        </select>
                        <span
                            class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-sm">expand_more</span>
                    </div>
                    @if(hasError('categoryId', 'required')) { <span class="text-xs text-red-500">Requerido</span> }
                </div>

                <div class="flex flex-col gap-1">
                    <label class="text-sm font-semibold text-[#181411] dark:text-white">Precio (€)</label>
                    <input formControlName="price" type="number" step="0.01"
                        class="form-input w-full px-3 py-2 rounded-lg border border-[#e6e0db] dark:border-white/10 bg-white dark:bg-black/20 text-[#181411] dark:text-white focus:border-[#f27f0d] focus:ring-1 focus:ring-[#f27f0d] outline-none transition-all" />
                    @if(hasError('price', 'required')) { <span class="text-xs text-red-500">Requerido</span> }
                    @if(hasError('price', 'min')) { <span class="text-xs text-red-500">Mayor o igual a 0</span> }
                </div>
            </div>

            <!-- Description -->
            <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-[#181411] dark:text-white">Descripción</label>
                <textarea formControlName="description" rows="3"
                    class="form-textarea w-full px-3 py-2 rounded-lg border border-[#e6e0db] dark:border-white/10 bg-white dark:bg-black/20 text-[#181411] dark:text-white focus:border-[#f27f0d] focus:ring-1 focus:ring-[#f27f0d] outline-none transition-all resize-none placeholder:text-gray-400"
                    placeholder="Detalles del producto..."></textarea>
            </div>

            <!-- Image Upload -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold text-[#181411] dark:text-white">Imagen</label>

                <div class="border-2 border-dashed border-gray-300 dark:border-white/10 rounded-xl p-6 flex flex-col items-center justify-center text-center transition-colors hover:border-[#f27f0d] group bg-gray-50 dark:bg-black/20 relative"
                    (drop)="onDrop($event)" (dragover)="onDragOver($event)">

                    @if (imagePreviewUrl) {
                    <div class="relative w-full h-48 flex items-center justify-center">
                        <img [src]="imagePreviewUrl" class="max-h-full max-w-full object-contain rounded-lg shadow-sm"
                            alt="Preview">
                        <button type="button" (click)="removeImage()"
                            class="absolute top-0 right-0 p-1 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition-colors transform translate-x-1/2 -translate-y-1/2">
                            <span class="material-symbols-outlined text-sm font-bold">close</span>
                        </button>
                    </div>
                    } @else {
                    <div
                        class="pointer-events-none flex flex-col items-center gap-2 text-gray-400 group-hover:text-[#f27f0d] transition-colors">
                        <span class="material-symbols-outlined text-4xl">cloud_upload</span>
                        <span class="text-sm">Arrastra tu imagen aquí o haz clic para subir</span>
                    </div>
                    }

                    <input type="file" class="absolute inset-0 opacity-0 cursor-pointer"
                        (change)="onFileInputChange($event)" accept="image/png, image/jpeg, image/jpg, image/webp"
                        [disabled]="!!imagePreviewUrl" />
                </div>
                <p class="text-xs text-gray-400 text-center">Formatos: PNG, JPG, WebP</p>
            </div>

        </form>

        <!-- Footer -->
        <div
            class="px-6 py-4 border-t border-[#e6e0db] dark:border-white/10 flex items-center justify-end gap-3 bg-gray-50 dark:bg-black/20 rounded-b-xl">
            <button type="button" (click)="onClose()"
                class="px-4 py-2 hover:cursor-pointer rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-black/5 dark:hover:bg-white/5 transition-colors"
                [disabled]="saving">
                Cancelar
            </button>
            <button type="button" (click)="onSubmit()"
                class="px-4 py-2 hover:cursor-pointer rounded-lg text-sm font-bold text-white bg-[#f27f0d] hover:bg-[#f27f0d]/90 shadow-lg shadow-[#f27f0d]/20 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                [disabled]="saving || form.invalid">
                @if(saving) {
                <span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>
                Guardando...
                } @else {
                Guardar
                }
            </button>
        </div>

    </div>
</div>
}